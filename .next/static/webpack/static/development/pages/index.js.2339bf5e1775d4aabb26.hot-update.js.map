{"version":3,"file":"static/webpack/static\\development\\pages\\index.js.2339bf5e1775d4aabb26.hot-update.js","sources":["webpack:///./pages/index.js"],"sourcesContent":["import {useEffect} from 'react'\r\nimport {Button,Icon,Tabs} from 'antd' \r\nimport getConfig from 'next/config'\r\nimport {connect} from 'react-redux'\r\nimport Router,{withRouter} from 'next/router'\r\nimport LRU from 'lru-cache'\r\n\r\nimport Repo from '../components/Repo'\r\n\r\nconst api=require('../lib/api')\r\n\r\nconst { publicRuntimeConfig } = getConfig()\r\n\r\nconst isServer=typeof window ==='undefined'\r\n\r\n//注意缓存在客户端和服务端公用的情况，引入isServer判断 并且设置了时效\r\nconst cache=new LRU({\r\n  maxAge:1000*60*10  //最长10min不去使用缓存数据就清空\r\n})\r\n function Index({userRepos,userStaredRepos,user,router}){\r\n  console.log(userRepos,userStaredRepos,user,router)\r\n  const tabKey=router.query.key || '1';\r\n  const handleTabChange= activeKey =>{\r\n     Router.push(`/?key=${activeKey}`)\r\n  }\r\n  //第一次进来发现有数据就会被缓存\r\n  useEffect(()=>{\r\n    if(!isServer){\r\n      //不是服务端的情况下，对数据进行缓存，方便再次进入不需要调接口\r\n      if(userRepos){\r\n        cache.set('userRepos',userRepos)\r\n      }\r\n      if(userStaredRepos){\r\n        cache.set('userStaredRepos',userStaredRepos)\r\n      }\r\n    }\r\n  },[userRepos,userStaredRepos])  //监听参数发生变化则会调用\r\n   if(!user||!user.id){\r\n     return <div className=\"root\">\r\n       <p>亲，您还没有登录哦~</p>\r\n       <Button type=\"primary\" href={publicRuntimeConfig.OAUTH_URL}>点击登录</Button>\r\n       <style jsx>{`\r\n        .root{\r\n          height:400px;\r\n          display:flex;\r\n          flex-direction:column;\r\n          justify-content:center;\r\n          align-items:center;\r\n        }\r\n       `}</style>\r\n     </div>\r\n   }\r\n    return (\r\n      <div className=\"root\">\r\n          <div className=\"user-info\">\r\n              <img src={user.avatar_url} alt=\"user avatar\" className=\"avatar\" />\r\n              <span className=\"login\">{user.login}</span>\r\n              <span className=\"name\">{user.name}</span>\r\n              <span className=\"bio\">{user.bio}</span>\r\n              <p className=\"email\">\r\n                  <Icon type=\"mail\" style={{marginRight:10}}></Icon>\r\n                  <a href={user.html_url} target=\"_black\">{user.html_url}</a>\r\n              </p>\r\n          </div>\r\n          <div className=\"user-repos\">\r\n                <Tabs activeKey={tabKey} onChange={handleTabChange} animated={false}>\r\n                  <Tabs.TabPane tab=\"你的仓库\" key=\"1\">\r\n                    {userRepos.map(repo=>(\r\n                      <Repo key={repo.id} repo={repo} />\r\n                    ))}\r\n                  </Tabs.TabPane>\r\n                  <Tabs.TabPane tab=\"你关注的仓库\" key=\"2\">\r\n                    {userStaredRepos.map(repo=>(\r\n                      <Repo key={repo.id} repo={repo} />\r\n                    ))}\r\n                  </Tabs.TabPane>\r\n                </Tabs>\r\n          </div>\r\n          <style jsx>{`\r\n            .root{\r\n              display:flex;\r\n              align-items:flex-start;\r\n              padding:20px 0;\r\n            }\r\n            .user-info{\r\n              width:200px;\r\n              margin-right:40px;\r\n              flex-shrink:0;\r\n              display:flex;\r\n              flex-direction:column;\r\n            }\r\n            .login{\r\n              font-weight:800;\r\n              font-size:20px;\r\n              margin-top:20px;\r\n            }\r\n            .name{\r\n              font-size:16px;\r\n              color:#777;\r\n            }\r\n            .bio{\r\n              font-size:20px;\r\n              color:#333;\r\n            }\r\n            .avatar{\r\n              width:100%;\r\n              border-radius:5px;\r\n            }\r\n            .user-repos{\r\n              flex-grow:1;  \r\n            }\r\n            `}</style>\r\n      </div>\r\n    )\r\n }\r\n //服务端和客户端都会执行\r\n /**\r\n  * 客户端切换与访问Index页面服务端渲染都会执行getInitialProps\r\n  * 在服务端渲染的时候，运行环境是处于nodejs环境，而不是处于浏览器的环境\r\n  * 在nodejs环境中axios.get('/github/search/repositories?q=react')方式请求，会请求'http://localhost:80/github/search/repositories?q=react'地址，这个地址明显请求不成功\r\n  * 解决的方式是请求api时判断是否为服务端，提取出公共的lib/api.js\r\n  * 客户端的请求会到server/api.js中做处理，返回给客户端\r\n  * 以上就是同构的概念——就是有部分代码都可能会在客户端和服务端执行，因此这段代码就要适应浏览器的执行环境，也要适应nodejs的执行环境，因此做区分处理，最终汇集到一个点requestGithub上面，保证在客户端和服务端都可正常执行\r\n  */\r\n Index.getInitialProps=async ({ctx,reduxStore})=>{\r\n  //  const result=await axios\r\n  //  .get('/github/search/repositories?q=react')\r\n  //  .then(resp=>console.log(resp))\r\n  const user=reduxStore.getState().user; //拿到用户信息\r\n  if(!user||!user.id){\r\n    return {\r\n      isLogin:false\r\n    }\r\n  }\r\n  if(!isServer){\r\n    //不是服务端的情况下，对数据进行缓存，再次进入不需要调接口，直接返回\r\n    if(cache.get('userRepos')&&cache.get('userStaredRepos')){\r\n      return {\r\n        userRepos:cache.get('userRepos'),\r\n        userStaredRepos:cache.get('userStaredRepos')\r\n      }\r\n    }\r\n  }\r\n  //ctx.req,ctx.res只有在服务端渲染时才会有\r\n  //调用当前用户的仓库列表\r\n  const userRepos= await api.request(\r\n    {\r\n      url: '/user/repos',\r\n    },\r\n    ctx.req,\r\n    ctx.res,\r\n  )\r\n  //调用关注的仓库列表\r\n  const userStaredRepos= await api.request(\r\n    {\r\n      url: '/user/starred',\r\n    },\r\n    ctx.req,\r\n    ctx.res,\r\n  )\r\n   return {\r\n     isLogin:true,\r\n     userRepos:userRepos.data,\r\n     userStaredRepos:userStaredRepos.data\r\n   }\r\n }\r\n\r\nexport default withRouter(\r\n  connect(function mapState(state) {\r\n    return {\r\n      user: state.user,\r\n    }\r\n  })(Index),\r\n)"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AAEA;AACA;AACA;AAFA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AACA;AAAA;AAAA;AAFA;AAAA;AAaA;AACA;AAAA;AACA;AAAA;AACA;AAAA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AACA;AAAA;AACA;AAAA;AACA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAGA;AAAA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AADA;AAIA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AADA;AAnBA;AAAA;AA6DA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AADA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AALA;AAAA;AAAA;AAAA;AACA;AADA;AAOA;AADA;AACA;AAPA;AAAA;AAAA;AAAA;AAAA;AACA;AADA;AAAA;AAAA;AAAA;AACA;AADA;AAcA;AACA;AAFA;AACA;AAdA;AAAA;AAAA;AAuBA;AADA;AACA;AAvBA;AAqBA;AArBA;AAAA;AA+BA;AADA;AACA;AA/BA;AA6BA;AA7BA;AAqCA;AACA;AACA;AAHA;AACA;AArCA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AADA;AAAA;AAAA;AAAA;AACA;AA0CA;AAEA;AACA;AADA;AAGA;;;;A","sourceRoot":""}